---
import PublicLayout from '../../../layouts/PublicLayout.astro';
import { resolveLangFromParams, getTranslations, supportedLangs } from '../../../i18n/index';
import type { Lang, I18nSchema } from '../../../i18n/types';
import { callBackendJsonParse } from '../../../shared/api/client';

export const prerender = false;

export async function getStaticPaths() {
  // Dynamic artists – we only predefine languages, slug is resolved at runtime.
  return supportedLangs.map((lang) => ({
    params: { lang, username: 'placeholder' },
  }));
}

interface PublicArtistPortfolioItem {
  id: number;
  url: string;
  width: number;
  height: number;
  kind: 'portfolio' | 'wannado';
  title?: string | null;
  description?: string | null;
  approx_price?: string | null;
  placement?: string | null;
}

interface PublicArtistStudio {
  id: number;
  slug: string;
  display_name: string;
  avatar_url?: string | null;
}

interface PublicArtistProfile {
  username: string;
  about?: string | null;
  styles: string[];
  city?: string | null;
  session_price?: number | null;
  instagram?: string | null;
  telegram?: string | null;
  vk?: string | null;
  avatar_url?: string | null;
  banner_url?: string | null;
  portfolio: PublicArtistPortfolioItem[];
  wannado: PublicArtistPortfolioItem[];
  studios: PublicArtistStudio[];
}

const lang: Lang = resolveLangFromParams(Astro.params.lang);
const t: I18nSchema = getTranslations(lang);
const currentPath = Astro.url.pathname;
const slugParam = Astro.params.username as string;

let profile: PublicArtistProfile | null = null;
let notFound = false;
let errorMessage: string | null = null;

try {
  profile = await callBackendJsonParse<PublicArtistProfile>(`/api/v1/public/artists/${encodeURIComponent(slugParam)}`);
} catch (error: any) {
  if (error?.message === 'Artist not found' || error?.message?.includes('not found')) {
    notFound = true;
  } else {
    notFound = true;
    errorMessage = error?.message || 'Failed to load artist';
  }
}

if (notFound || !profile) {
  const message = errorMessage || 'Artist not found';
  return new Response(message, {
    status: 404,
    statusText: message,
  });
}

const artistName = profile.username;
const hasSocial = !!profile.instagram || !!profile.telegram || !!profile.vk;
---

<PublicLayout title={artistName} lang={lang} t={t} currentPath={currentPath}>
  <section class="mb-8 rounded-lg overflow-hidden border border-[var(--inkq-border)] bg-[var(--inkq-surface)]">
    <div class="relative">
      <div class="h-48 md:h-56 w-full overflow-hidden bg-[var(--inkq-bg-subtle)]">
        <img
          src={profile.banner_url || '/placeholder-banner.svg'}
          alt="Banner"
          class="w-full h-full object-cover"
        />
      </div>
      <div class="absolute -bottom-10 left-6 flex items-end gap-4">
        <div class="w-24 h-24 md:w-28 md:h-28 rounded-full border-4 border-[var(--inkq-surface)] bg-[var(--inkq-bg-subtle)] overflow-hidden flex items-center justify-center">
          {profile.avatar_url ? (
            <img
              src={profile.avatar_url}
              alt={artistName}
              class="w-full h-full object-cover"
            />
          ) : (
            <span class="text-2xl font-semibold text-[var(--inkq-muted)]">
              {artistName.charAt(0).toUpperCase()}
            </span>
          )}
        </div>
        <div class="pb-2">
          <h1 class="text-2xl md:text-3xl font-bold text-[var(--inkq-fg)]">
            {artistName}
          </h1>
          <p class="text-sm text-[var(--inkq-muted)]">
            {t.profile.roleArtist}
            {profile.city ? ` • ${profile.city}` : ''}
          </p>
          {profile.session_price && (
            <p class="text-sm text-[var(--inkq-fg)] mt-1">
              {lang === 'ru'
                ? `От ${profile.session_price} за сеанс`
                : `From ${profile.session_price} per session`}
            </p>
          )}
        </div>
      </div>
    </div>

    <div class="pt-14 pb-4 px-6 md:px-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex flex-wrap gap-2">
        {profile.styles.length > 0 ? (
          profile.styles.map((style) => (
            <span class="px-3 py-1 text-xs rounded-full bg-[var(--inkq-bg-subtle)] text-[var(--inkq-fg)]">
              {style}
            </span>
          ))
        ) : (
          <span class="text-xs text-[var(--inkq-muted)]">
            {lang === 'ru' ? 'Стили не указаны' : 'Styles not specified'}
          </span>
        )}
      </div>

      {hasSocial && (
        <div class="flex flex-wrap items-center gap-4">
          {profile.telegram && (
            <a
              href={profile.telegram.startsWith('http') ? profile.telegram : `https://t.me/${profile.telegram.replace('@', '')}`}
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Open artist Telegram profile"
              class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-[var(--inkq-bg)] text-[var(--inkq-fg)] border-2 border-[var(--inkq-border)] hover:bg-[var(--inkq-bg-subtle)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--inkq-muted)] transition-colors"
            >
              <svg
                class="w-7 h-7"
                fill="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.13-.31-1.09-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
              </svg>
              <span class="sr-only">Telegram</span>
            </a>
          )}
          {profile.instagram && (
            <a
              href={profile.instagram.startsWith('http') ? profile.instagram : `https://instagram.com/${profile.instagram.replace('@', '')}`}
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Open artist Instagram profile"
              class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-[var(--inkq-bg)] text-[var(--inkq-fg)] border-2 border-[var(--inkq-border)] hover:bg-[var(--inkq-bg-subtle)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--inkq-muted)] transition-colors"
            >
              <svg
                class="w-7 h-7"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
                <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
                <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/>
              </svg>
              <span class="sr-only">Instagram</span>
            </a>
          )}
          {profile.vk && (
            <a
              href={profile.vk.startsWith('http') ? profile.vk : `https://vk.com/${profile.vk.replace('@', '')}`}
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Open artist VK profile"
              class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-[var(--inkq-bg)] text-[var(--inkq-fg)] border-2 border-[var(--inkq-border)] hover:bg-[var(--inkq-bg-subtle)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--inkq-muted)] transition-colors"
            >
              <svg
                class="w-7 h-7"
                fill="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <path d="M12.785 16.241s.287-.029.435-.18c.135-.137.131-.393.131-.393s-.02-1.123.515-1.288c.526-.164 1.2 1.09 1.912 1.57.54.36.95.281.95.281l1.912-.027s1-.064.525-.855c-.039-.064-.277-.576-1.425-1.63-1.205-1.11-1.043-.931.408-2.853.28-.37.785-1.23.785-1.23s.18-.43-.09-.667c-.27-.235-.64-.155-.64-.155l-1.846.011s-.27-.03-.47.09c-.193.117-.315.39-.315.39s-.563 1.5-1.31 2.776c-1.58 2.52-2.214 2.655-2.472 2.503-.6-.352-.45-1.41-.45-2.163 0-2.353.35-3.337-.685-3.59-.345-.085-.598-.143-1.48-.152-1.13-.01-2.085.003-2.625.27-.36.18-.638.58-.47.603.21.03.686.13.94.475.33.45.318 1.46.318 1.46s.19 2.81-.445 3.157c-.437.24-1.04-.25-2.33-2.5-.66-1.14-1.16-2.4-1.16-2.4s-.1-.24-.27-.37c-.21-.16-.5-.21-.5-.21l-1.76.011s-.53.016-.725.24c-.17.19-.13.48-.13.48s1.05 2.48 2.24 4.67c2.09 3.5 3.01 4.11 3.01 4.11s.18.12.28.07c.1-.05.68-.44 1.36-1.48.86-1.33 1.51-2.76 1.51-2.76s.12-.24.3-.03c.18.21.69.85 1.48 1.63 1 .95 1.75 1.25 1.75 1.25z"/>
              </svg>
              <span class="sr-only">VK</span>
            </a>
          )}
        </div>
      )}
    </div>
  </section>

  <!-- Tabs -->
  <div class="mb-4 border-b border-[var(--inkq-border)] flex gap-4">
    <button
      type="button"
      class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-[var(--inkq-muted)] data-[active='true']:border-[var(--inkq-fg)] data-[active='true']:text-[var(--inkq-fg)]"
      data-tab-trigger="about"
      data-active="true"
    >
      {t.profile.aboutTitle}
    </button>
    <button
      type="button"
      class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-[var(--inkq-muted)] data-[active='true']:border-[var(--inkq-fg)] data-[active='true']:text-[var(--inkq-fg)]"
      data-tab-trigger="portfolio"
      data-active="false"
    >
      {t.profile.portfolioTitle}
    </button>
    <button
      type="button"
      class="px-3 py-2 text-sm font-medium border-b-2 border-transparent text-[var(--inkq-muted)] data-[active='true']:border-[var(--inkq-fg)] data-[active='true']:text-[var(--inkq-fg)]"
      data-tab-trigger="wannado"
      data-active="false"
    >
      {t.profile.wannadoTab}
    </button>
  </div>

  <!-- About tab -->
  <section data-tab-panel="about">
    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-[var(--inkq-fg)]">{t.profile.aboutTitle}</h2>
      {profile.about ? (
        <p class="text-[var(--inkq-fg)] leading-relaxed whitespace-pre-wrap">
          {profile.about}
        </p>
      ) : (
        <p class="text-[var(--inkq-muted)]">{t.profile.emptyAbout}</p>
      )}
      <div class="text-sm text-[var(--inkq-muted)] space-y-1">
        <p>
          <strong>{t.profile.cityLabel}:</strong>{' '}
          {profile.city || (lang === 'ru' ? 'Не указан' : 'Not specified')}
        </p>
        <p>
          <strong>{t.profile.sessionPriceLabel}:</strong>{' '}
          {profile.session_price
            ? lang === 'ru'
              ? `От ${profile.session_price} за сеанс`
              : `From ${profile.session_price} per session`
            : lang === 'ru'
              ? 'Не указано'
              : 'Not specified'}
        </p>
      </div>
    </div>
  </section>

  <!-- Portfolio tab -->
  <section data-tab-panel="portfolio" class="hidden">
    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-[var(--inkq-fg)]">{t.profile.portfolioTitle}</h2>
      {profile.portfolio.length === 0 ? (
        <p class="text-[var(--inkq-muted)]">{t.profile.emptyPortfolio}</p>
      ) : (
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          {profile.portfolio.map((item) => (
            <button
              type="button"
              class="relative aspect-square overflow-hidden rounded-lg border border-[var(--inkq-border)] bg-[var(--inkq-bg-subtle)] group"
              data-lightbox-image={item.url}
            >
              <img
                src={item.url}
                alt="Portfolio image"
                class="w-full h-full object-cover group-hover:scale-105 transition-transform"
                loading="lazy"
              />
            </button>
          ))}
        </div>
      )}
    </div>
  </section>

  <!-- Wannado tab -->
  <section data-tab-panel="wannado" class="hidden">
    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-[var(--inkq-fg)]">{t.profile.wannadoTab}</h2>
      {profile.wannado.length === 0 ? (
        <p class="text-[var(--inkq-muted)]">{t.profile.emptyWannado}</p>
      ) : (
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          {profile.wannado.map((item) => (
            <button
              type="button"
              class="relative aspect-square overflow-hidden rounded-lg border border-[var(--inkq-border)] bg-[var(--inkq-bg-subtle)] group"
              data-lightbox-image={item.url}
            >
              <img
                src={item.url}
                alt="Wannado image"
                class="w-full h-full object-cover group-hover:scale-105 transition-transform"
                loading="lazy"
              />
            </button>
          ))}
        </div>
      )}
    </div>
  </section>

  <!-- Studios Section -->
  {profile.studios.length > 0 && (
    <section class="mt-8 bg-[var(--inkq-surface)] rounded-lg p-6 border border-[var(--inkq-border)] space-y-4">
      <h2 class="text-xl font-semibold text-[var(--inkq-fg)]">
        {t.profile.studiosTitle}
      </h2>
      <p class="text-sm text-[var(--inkq-muted)] mb-4">
        {t.profile.worksAt}
      </p>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {profile.studios.map((studio) => (
          <a
            href={`/${lang}/studios/${studio.slug}`}
            class="block p-4 rounded-lg border border-[var(--inkq-border)] hover:border-[var(--inkq-muted)] transition-colors"
          >
            <div class="flex items-center gap-3">
              {studio.avatar_url ? (
                <img
                  src={studio.avatar_url}
                  alt={studio.display_name}
                  class="w-12 h-12 rounded-full object-cover"
                />
              ) : (
                <div class="w-12 h-12 rounded-full bg-[var(--inkq-bg-subtle)] flex items-center justify-center text-lg font-semibold text-[var(--inkq-muted)]">
                  {studio.display_name.charAt(0).toUpperCase()}
                </div>
              )}
              <div>
                <h3 class="font-semibold text-[var(--inkq-fg)]">
                  {studio.display_name}
                </h3>
              </div>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}

  <!-- Lightbox -->
  <div
    id="artist-lightbox"
    class="fixed inset-0 bg-black/80 flex items-center justify-center z-40 opacity-0 pointer-events-none transition-opacity"
  >
    <button
      type="button"
      id="artist-lightbox-close"
      class="absolute top-4 right-4 text-white text-2xl"
      aria-label="Close"
    >
      ×
    </button>
    <img
      id="artist-lightbox-image"
      src=""
      alt="Preview"
      class="max-w-full max-h-[80vh] rounded-lg shadow-xl"
    />
  </div>
</PublicLayout>

<script>
  // Tabs
  const triggers = document.querySelectorAll('[data-tab-trigger]');
  const panels = document.querySelectorAll('[data-tab-panel]');

  function setActiveTab(name) {
    triggers.forEach((btn) => {
      const isActive = btn.getAttribute('data-tab-trigger') === name;
      btn.setAttribute('data-active', isActive ? 'true' : 'false');
    });
    panels.forEach((panel) => {
      const isActive = panel.getAttribute('data-tab-panel') === name;
      if (isActive) {
        panel.classList.remove('hidden');
      } else {
        panel.classList.add('hidden');
      }
    });
  }

  triggers.forEach((btn) => {
    btn.addEventListener('click', () => {
      const name = btn.getAttribute('data-tab-trigger');
      if (name) setActiveTab(name);
    });
  });

  // Lightbox
  const lightbox = document.getElementById('artist-lightbox');
  const lightboxImage = document.getElementById('artist-lightbox-image');
  const lightboxClose = document.getElementById('artist-lightbox-close');

  function openLightbox(url) {
    if (!lightbox || !lightboxImage) return;
    lightboxImage.src = url;
    lightbox.classList.remove('pointer-events-none');
    lightbox.classList.add('opacity-100');
  }

  function closeLightbox() {
    if (!lightbox || !lightboxImage) return;
    lightbox.classList.add('pointer-events-none');
    lightbox.classList.remove('opacity-100');
    lightboxImage.src = '';
  }

  document.querySelectorAll('[data-lightbox-image]').forEach((el) => {
    el.addEventListener('click', () => {
      const url = el.getAttribute('data-lightbox-image');
      if (url) openLightbox(url);
    });
  });

  if (lightboxClose) {
    lightboxClose.addEventListener('click', closeLightbox);
  }

  if (lightbox) {
    lightbox.addEventListener('click', (event) => {
      if (event.target === lightbox) {
        closeLightbox();
      }
    });
  }
</script>
